version: '3.8'

services:
  # Echo service - the backend module that the proxy will forward to
  echo-service:
    image: rokkon/echo-service:1.0.0-SNAPSHOT
    container_name: echo-service
    networks:
      - proxy-test-network
    ports:
      - "9091:9090"  # Expose for direct testing if needed
    environment:
      - GRPC_PORT=9090
    healthcheck:
      test: ["CMD", "grpcurl", "-plaintext", "localhost:9090", "list"]
      interval: 5s
      timeout: 3s
      retries: 10

  # Module proxy - the Quarkus proxy that sits in front of echo-service
  module-proxy:
    image: rokkon/proxy-module:latest
    container_name: module-proxy
    networks:
      - proxy-test-network
    ports:
      - "8080:8080"  # HTTP/REST endpoints
      - "9090:9090"  # gRPC endpoint
    environment:
      - MODULE_HOST=echo-service
      - MODULE_PORT=9090
      - PROXY_PORT=8080
      - QUARKUS_HTTP_PORT=8080
      - QUARKUS_GRPC_SERVER_PORT=9090
    depends_on:
      echo-service:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/q/health/ready"]
      interval: 5s
      timeout: 3s
      retries: 10

networks:
  proxy-test-network:
    driver: bridge
